<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.test.goal.dao.BoardMapper">
	
	<!-- 게시글 목록, 검색, 페이징 -->
	<select id="boardList" parameterType="map" resultType="BoardVO">
		select b.userid as "userid", b.favorite as "favorite",t.tGoalNum as "tGoalNum", t.tGoalTitle as "tGoalTitle", t.tStartDate as "startDate", t.tEndDate as "endDate", t.openStatus as "openStatus", t.progressNum as "progressNum", l.currentMemberNumber as "currentMemberNumber", m.maxMember as "maxMember", m.type as "type"
		from board b inner join topGoal t
		on b.tGoalNum = t.tGoalNum inner join mainProgress m
		on t.progressNum = m.progressNum inner join (select progressNum, count(listNum) as currentMemberNumber from memberList group by progressNum) l
		on m.progressNum = l.progressNum
		<if test="searchSelect == 'ID'">
			where b.userid like '%'||#{searchKeyid}||'%'
		</if>
		<if test="searchSelect == 'TITLE'">
			where t.tGoalTitle like '%'||#{searchKeyid}||'%'
		</if>
		order by b.favorite desc
	</select>
	
	<!-- 페이징 : 전체 게시글 수 가져오기 -->
	<select id="getTotal" parameterType="map" resultType="int">
		select count(*) from board b inner join topGoal t
		on b.tGoalNum = t.tGoalNum inner join mainProgress m
		on t.progressNum = m.progressNum inner join (select progressNum, count(listNum) as currentMemberNumber from memberList group by progressNum) l
		on m.progressNum = l.progressNum
		<if test="searchSelect == 'ID'">
			where b.userid like '%'||#{searchKeyid}||'%'
		</if>
		<if test="searchSelect == 'TITLE'">
			where t.tGoalTitle like '%'||#{searchKeyid}||'%'
		</if>
		order by b.favorite desc
	</select>

	<!-- 게시글 좋아요 -->
	<update id="favorite" parameterType="int">
		update board set favorite = favorite + 1 where boardnum = #{boardnum}	
	</update>
	
	
</mapper>